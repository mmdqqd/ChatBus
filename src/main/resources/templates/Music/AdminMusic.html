<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>
<header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
  <a href="" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
    <svg t="1734919596857" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4279" width="32" height="32"><path d="M537.216 1003.776h-427.52c-27.072 0-52.8-11.456-70.592-31.296a76.352 76.352 0 0 1-19.904-58.88l-0.192-60.16a32 32 0 0 1 64 0v63.872c-0.384 5.44 0.576 8.832 3.968 12.608a30.656 30.656 0 0 0 22.72 9.856h427.52a32 32 0 0 1 0 64z" fill="#231815" p-id="4280"></path><path d="M50.752 934.144a32 32 0 0 1-32-32v-60.032a457.536 457.536 0 0 1 277.952-421.12 32.192 32.192 0 0 1 42.048 16.832 32.128 32.128 0 0 1-16.896 42.112 393.408 393.408 0 0 0-239.104 362.24v60.032a32 32 0 0 1-32 31.936z" fill="#231815" p-id="4281"></path><path d="M460.736 514.496a247.36 247.36 0 0 1-247.104-247.104A247.424 247.424 0 0 1 460.736 20.224a247.424 247.424 0 0 1 247.168 247.168 247.36 247.36 0 0 1-247.168 247.104z m0-430.272a183.36 183.36 0 0 0-183.104 183.168 183.296 183.296 0 0 0 183.104 183.104 183.36 183.36 0 0 0 183.168-183.104 183.36 183.36 0 0 0-183.168-183.168zM778.56 829.376c-42.944 0-77.888-34.944-77.888-77.888s34.944-77.888 77.888-77.888 77.888 34.944 77.888 77.888-34.944 77.888-77.888 77.888z m0-110.976a33.216 33.216 0 1 0 0.064 66.368 33.216 33.216 0 0 0-0.064-66.368z" fill="#231815" p-id="4282"></path><path d="M834.56 960.384a22.4 22.4 0 0 1-22.144-19.2 35.2 35.2 0 0 0-34.56-30.208c-17.152 0-32 12.864-34.624 30.016a22.272 22.272 0 0 1-28.736 17.984 217.536 217.536 0 0 1-84.352-49.344 22.4 22.4 0 0 1 1.28-33.728 35.136 35.136 0 0 0 8.32-44.864 35.84 35.84 0 0 0-42.88-15.04 22.4 22.4 0 0 1-29.76-15.936c-3.712-16.448-5.632-32.768-5.632-48.64s1.92-32.192 5.632-48.64a22.144 22.144 0 0 1 11.2-14.72 22.528 22.528 0 0 1 18.496-1.216 34.944 34.944 0 1 0 34.56-59.968 22.336 22.336 0 0 1-8.192-16.64 21.248 21.248 0 0 1 6.976-16.96 217.472 217.472 0 0 1 84.352-49.28 22.4 22.4 0 0 1 28.672 18.048 35.328 35.328 0 0 0 34.624 29.952 35.2 35.2 0 0 0 34.56-30.208 22.4 22.4 0 0 1 28.608-18.304 217.6 217.6 0 0 1 85.248 49.088 22.336 22.336 0 0 1-1.472 34.048 34.88 34.88 0 0 0-8.896 45.056 35.84 35.84 0 0 0 43.776 14.784 22.592 22.592 0 0 1 30.208 15.552 214.336 214.336 0 0 1 0 98.816 22.592 22.592 0 0 1-30.336 15.552 35.456 35.456 0 0 0-43.648 14.72 35.008 35.008 0 0 0 8.96 45.184 22.4 22.4 0 0 1 1.408 34.048 218.368 218.368 0 0 1-85.312 49.024 19.584 19.584 0 0 1-6.336 1.024z m-56.768-94.144c30.144 0 57.024 17.216 70.592 42.752 10.624-4.736 20.864-10.624 30.528-17.536a79.232 79.232 0 0 1-1.728-82.56 81.024 81.024 0 0 1 72.832-39.744 164.16 164.16 0 0 0 0-35.264 81.28 81.28 0 0 1-72.768-39.68 80.128 80.128 0 0 1 1.792-82.496 166.336 166.336 0 0 0-30.656-17.664c-13.504 25.6-40.448 42.816-70.592 42.816-29.824 0-56.64-17.024-70.336-42.304a179.072 179.072 0 0 0-30.336 17.792c15.104 24.384 16.256 55.68 1.28 81.792-14.528 25.216-43.008 42.432-71.296 39.872a147.776 147.776 0 0 0 0 35.008 83.84 83.84 0 0 1 71.296 39.744c15.04 26.24 13.888 57.536-1.216 81.92 9.472 6.976 19.648 12.928 30.336 17.792 13.696-25.216 40.512-42.24 70.272-42.24z" fill="#231815" p-id="4283"></path></svg>
    <span class="fs-4">音乐信息修改处</span>
  </a>
  <ul class="nav nav-pills">
    <li class="nav-item"><a href="/houtaiindex" class="nav-link active" aria-current="page">后台主页</a></li>&nbsp;&nbsp;
  </ul>
  <ul class="nav nav-pills">
    <li class="nav-item"><a href="/index" class="nav-link active" aria-current="page">前台主页</a></li>&nbsp;
  </ul>
</header>
<div class="container mt-5">
  <h1 class="mb-4">管理员音乐修改</h1>
  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addMusicModal">添加音乐</button>
  <table class="table" id="musicTable">
    <thead>
    <tr>
      <th>ID</th>
      <th>音乐名字</th>
      <th>点赞数</th>
      <th>踩数</th>
      <th>音乐图片</th>
      <th>播放</th>
      <th>修改</th>
    </tr>
    </thead>
    <tbody id="musicList">
    <!-- Music List will be populated here -->
    </tbody>
  </table>
</div>

<!-- 添加 Music Modal -->
<div class="modal fade" id="addMusicModal" tabindex="-1" aria-labelledby="addMusicModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addMusicModalLabel">添加音乐</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addMusicForm">
          <div class="mb-3">
            <label for="musicName" class="form-label">音乐名字</label>
            <input type="text" class="form-control" id="musicName" required>
          </div>
          <div class="mb-3">
            <label for="musicPng" class="form-label">音乐图片</label>
            <input type="file" class="form-control" id="musicPng" accept="image/*" required>
          </div>
          <div class="mb-3">
            <label for="musicAddress" class="form-label">上传音乐文件</label>
            <input type="file" class="form-control" id="musicAddress" accept="audio/mp3" required>
          </div>
          <div class="mb-3">
            <label for="musicLike" class="form-label">赞</label>
            <input type="number" class="form-control" id="musicLike" required>
          </div>
          <div class="mb-3">
            <label for="musicNotLike" class="form-label">踩</label>
            <input type="number" class="form-control" id="musicNotLike" required>
          </div>
          <button type="submit" class="btn btn-primary">保存</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editMusicModal" tabindex="-1" aria-labelledby="editMusicModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editMusicModalLabel">修改音乐</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editMusicForm">
          <input type="hidden" id="editMusicId">
          <div class="mb-3">
            <label for="editMusicName" class="form-label">音乐名字</label>
            <input type="text" class="form-control" id="editMusicName" >
          </div>
          <div class="mb-3">
            <label for="editMusicPng" class="form-label">音乐图片链接</label>
            <input type="file" class="form-control" id="editMusicPng" accept="image/*" >
          </div>
          <div class="mb-3">
            <label for="editMusicAddress" class="form-label">上传音乐文件</label>
            <input type="file" class="form-control" id="editMusicAddress" accept="audio/*" >
          </div>
          <div class="mb-3">
            <label for="editMusicLike" class="form-label">赞</label>
            <input type="number" class="form-control" id="editMusicLike" >
          </div>
          <div class="mb-3">
            <label for="editMusicNotLike" class="form-label">踩</label>
            <input type="number" class="form-control" id="editMusicNotLike" >
          </div>
          <button type="submit" class="btn btn-primary">保存</button>
        </form>



      </div>
    </div>
  </div>
</div>


<!-- 删除 Confirmation Modal -->
<div class="modal fade" id="deleteMusicModal" tabindex="-1" aria-labelledby="deleteMusicModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteMusicModalLabel">删除音乐</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>你确定删除吗?</p>
        <button type="button" id="confirmDelete" class="btn btn-danger">确认</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  $(document).ready(function() {
    // Load the music list
    loadMusicList();

    $("#addMusicForm").submit(function (e) {
      e.preventDefault();  // 阻止表单的默认提交行为

      // 获取表单数据
      const musicName = $("#musicName").val();
      const musicPngFile = $("#musicPng")[0].files[0];  // 获取上传的图片文件
      const musicFile = $("#musicAddress")[0].files[0];  // 获取 MP3 文件
      const musicLike = $("#musicLike").val();
      const musicNotLike = $("#musicNotLike").val();

      // 创建 FormData 对象来处理文件上传
      const formData = new FormData();

      // 将音乐信息作为 JSON 字符串添加到 FormData 中
      formData.append('music', JSON.stringify({
        musicName: musicName,
        musicLike: musicLike,
        musicNotLike: musicNotLike
      }));

      // 如果有上传图片，则将图片文件也添加到 FormData 中
      if (musicPngFile) {
        formData.append('musicPng', musicPngFile);
      }
      // 如果有上传音乐文件，则将 MP3 文件添加到 FormData 中
      if (musicFile) {
        formData.append('musicFile', musicFile);
      }

      // 发送 POST 请求到后端
      $.ajax({
        url: '/api/music',  // 后端接收新增音乐的 URL
        type: 'POST',
        processData: false,  // 不要处理数据
        contentType: false,  // 浏览器会自动设置 Content-Type 为 multipart/form-data
        data: formData,
        success: function(result) {
          $('#addMusicModal').modal('hide');  // 关闭模态框
          loadMusicList();  // 重新加载音乐列表
          // 重新加载音乐列表，或者做其他处理
        },
        error: function(err) {
          console.error(err);
          alert("添加音乐失败，请重试。");
        }
      });
    });


    $("#editMusicForm").submit(function(e) {
      e.preventDefault();

      const id = $("#editMusicId").val();  // 获取音乐ID

      // 构造要发送的JSON数据对象
      const data = {
        musicId: id,
        musicName: $("#editMusicName").val(),
        musicLike: $("#editMusicLike").val(),
        musicNotLike: $("#editMusicNotLike").val(),
      };

      // 获取文件
      const musicPng = $("#editMusicPng")[0].files[0];
      const musicAddress = $("#editMusicAddress")[0].files[0];

      // 创建 FormData 对象来同时发送 JSON 数据和文件
      const formData = new FormData();

      // 将 JSON 数据转为字符串，并添加到 FormData 中
      formData.append("data", JSON.stringify(data));

      // 如果有封面图片文件，继续上传
      if (musicPng) {
        formData.append("musicPng", musicPng);
      }

      // 如果有音乐文件，继续上传
      if (musicAddress) {
        formData.append("musicAddress", musicAddress);
      }

      // 发送 PUT 请求
      $.ajax({
        url: '/api/music/edit',  // 确保这是正确的 URL
        method: 'PUT',           // 使用 Put 请求
        data: formData,
        contentType: false,
        processData: false,
        success: function(result) {
          $('#editMusicModal').modal('hide');
          alert('音乐信息已保存');

          // 延迟5秒再执行 loadMusicList()

            loadMusicList();
          },

        error: function(xhr, status, error) {
          console.error('修改失败:', error);
          alert('修改失败，请重试');
        }
      });
    });







    // Delete music
    let musicToDelete;
    $("#confirmDelete").click(function () {
      $.ajax({
        url: '/api/music/' + musicToDelete,
        method: 'DELETE',
        success: function () {
          $('#deleteMusicModal').modal('hide');
          loadMusicList();
        }
      });
    });
    //
    // // Load music list
    // function loadMusicList() {
    //   $.ajax({
    //     url: '/api/music/a',
    //     method: 'GET',
    //     success: function (musicList) {
    //       $('#musicList').empty(); // 清空当前的音乐列表
    //       musicList.forEach(function (music) {
    //         // 确保图片和音频路径都可以正常访问
    //         const musicPngUrl = music.musicPng ? music.musicPng : 'default-image.png'; // 如果没有图片则使用默认图片
    //         const musicAddressUrl = music.musicAddress ? music.musicAddress : ''; // 确保有音频地址
    //
    //         $('#musicList').append(`
    //       <tr>
    //         <td>${music.id}</td>
    //         <td>${music.musicName}</td>
    //         <td>${music.musicLike}</td>
    //         <td>${music.musicNotLike}</td>
    //         <td><img src="${musicPngUrl}" alt="Image" width="50"></td>
    //         <td>
    //           <!-- 音乐播放器 -->
    //           ${musicAddressUrl ? `<audio controls><source src="${musicAddressUrl}" type="audio/mp3"></audio>` : '无音乐'}
    //         </td>
    //         <td>
    //           <button class="btn btn-warning edit-button" data-id="${music.id}">修改</button>
    //           <button class="btn btn-danger delete-button" data-id="${music.id}">删除</button>
    //         </td>
    //       </tr>
    //     `);
    //       });
    //     },
    //     error: function (err) {
    //       console.error("加载音乐列表失败", err);
    //       alert("加载音乐列表失败，请重试。");
    //     }
    //   });
    // }



    // Load music list
    function loadMusicList() {
      $.ajax({
        url: '/api/music/a', // 替换为实际 API 地址
        method: 'GET',
        success: function (response) {
          // 提取音乐列表数据
          const contentList = response.content; // 获取 content 数组
          if (!contentList || !Array.isArray(contentList)) {
            console.error("无效的音乐列表数据:", response);
            alert("加载音乐列表失败，服务器返回数据格式有误。");
            return;
          }

          // 清空当前的音乐列表
          const $musicList = $('#musicList');
          $musicList.empty();

          // 生成音乐列表行的 HTML
          const rowsHtml = contentList.map(function (music) {
            // 默认图片和音频路径
            const musicPngUrl = music.musicPng || 'default-image.png'; // 如果没有图片则使用默认图片
            const musicAddressUrl = music.musicAddress || ''; // 确保有音频地址

            // 返回一行 HTML
            return `
          <tr>
            <td>${music.id}</td>
            <td>${music.musicName}</td>
            <td>${music.musicLike}</td>
            <td>${music.musicNotLike}</td>
            <td><img src="${musicPngUrl}" alt="Image" width="50"></td>
            <td>
              <!-- 音乐播放器 -->
              ${musicAddressUrl
                    ? `<audio controls><source src="${musicAddressUrl}" type="audio/mp3"></audio>`
                    : '无音乐'}
            </td>
            <td>
              <button class="btn btn-warning edit-button" data-id="${music.id}">修改</button>
              <button class="btn btn-danger delete-button" data-id="${music.id}">删除</button>
            </td>
          </tr>
        `;
          }).join(''); // 将所有行拼接成一个完整的 HTML 字符串

          // 一次性插入所有 HTML 行
          $musicList.html(rowsHtml);
        },
        error: function (err) {
          console.error("加载音乐列表失败", err);
          alert("加载音乐列表失败，请重试。");
        }
      });
    }
    
    $(document).ready(function () {
      // Edit music
      $(document).on('click', '.edit-button', function () {
        var id = $(this).data('id');
        $.ajax({
          url: '/api/music/' + id,
          method: 'GET',
          success: function (music) {
            $("#editMusicId").val(music.id);
            $("#editMusicName").val(music.musicName);
            $("#editMusicLike").val(music.musicLike);
            $("#editMusicNotLike").val(music.musicNotLike);
            $('#editMusicModal').modal('show');
            loadMusicList();
          }
        });
      });

      // Confirm delete
      $(document).on('click', '.delete-button', function () {
        var id = $(this).data('id');
        musicToDelete = id;
        $('#deleteMusicModal').modal('show');
      });

      // Delete music
      $("#confirmDelete").click(function () {
        $.ajax({
          url: '/api/music/' + musicToDelete,
          method: 'DELETE',
          success: function () {
            $('#deleteMusicModal').modal('hide');
            loadMusicList();
          }
        });
      });
    });


  });
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>
</html>
