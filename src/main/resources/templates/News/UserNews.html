<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>News Management</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }

    .query-box, .news-card {
      background-color: #ffffff;
      border-radius: 5px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .news-card h5 {
      font-weight: bold;
    }

    .btn-query {
      background-color: #d9251c;
      color: white;
      font-weight: bold;
    }

    .btn-query:hover {
      background-color: #b71c15;
    }

    .pagination {
      justify-content: center;
    }

    .red-text {
      color: #d9251c;
      font-weight: bold;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
    <a href="" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
      <svg t="1734920174334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8670" width="32" height="32"><path d="M 865.69 513.434 c -13.5168 0 -24.576 11.0592 -24.576 24.576 v 235.52 c 0 43.008 -34.816 77.824 -77.824 77.824 H 240.23 c -43.008 0 -77.824 -34.816 -77.824 -77.824 V 250.47 c 0 -43.008 34.816 -77.824 77.824 -77.824 h 235.52 c 13.5168 0 24.576 -11.0592 24.576 -24.576 s -11.0592 -24.576 -24.576 -24.576 h -235.52 c -70.0416 0 -126.976 56.9344 -126.976 126.976 v 523.059 c 0 70.0416 56.9344 126.976 126.976 126.976 h 523.059 c 70.0416 0 126.976 -56.9344 126.976 -126.976 v -235.52 c 0 -13.5168 -10.8544 -24.576 -24.576 -24.576 Z" p-id="8671" fill="#d4237a"></path><path d="M 678.912 208.486 L 345.702 541.696 l -10.24 10.24 c -3.6864 3.8912 -6.7584 8.6016 -8.3968 13.5168 l -37.0688 111.206 a 35.0003 35.0003 0 0 0 39.936 45.2608 l 124.518 -24.9856 c 6.7584 -1.4336 12.9024 -4.7104 17.8176 -9.4208 l 9.8304 -9.8304 l 387.686 -387.686 c 7.168 -7.168 10.8544 -17.2032 10.0352 -27.2384 a 128.614 128.614 0 0 0 -118.989 -118.989 c -10.24 -0.8192 -20.0704 2.8672 -27.2384 10.0352 l -54.6816 54.6816 Z M 464.486 625.664 l -66.56 -66.56 L 696.32 260.71 l 66.56 66.56 l -298.394 298.394 Z m -96.6656 -27.0336 l 54.6816 54.6816 l -78.2336 15.5648 l 23.552 -70.2464 Z M 763.29 193.536 c 34.4064 5.3248 61.2352 32.1536 66.56 66.56 l -32.3584 32.3584 l -66.56 -66.56 l 32.3584 -32.3584 Z" p-id="8672" fill="#d4237a"></path></svg>
      <span class="fs-4">开始留言</span>
    </a>
    <ul class="nav nav-pills">
      <li class="nav-item"><a href="/liuyanban" class="nav-link active" aria-current="page">前往留言板</a></li>&nbsp;&nbsp;
    </ul>
    <ul class="nav nav-pills">
      <li class="nav-item"><a href="/index" class="nav-link active" aria-current="page">主页</a></li>
    </ul>
  </header>

  <!-- Search and Create News Section -->
  <div class="row">
    <!-- Left Column: Search Bar and Filters -->
    <!-- Right Column: News Form for Creating or Editing News -->
    <div class="col-md-9">
      <div class="news-card">
        <form id="newsForm">
          <input type="hidden" id="newsId">
<!--          <div class="mb-3">-->
<!--            <label for="avatarUrl" class="form-label">头像展示</label>-->
<!--            &lt;!&ndash; 使用 img 标签来显示头像 &ndash;&gt;-->
<!--            <img id="avatarUrl" src="" alt="头像" class="img-fluid" style="max-width: 150px;">-->
<!--          </div>-->
<!--          功能实现但是还没与用户头像关联，改代码太麻烦，所以直接弃用这个功能-->

          <div class="mb-3">
            <label for="username" class="form-label">用户名</label>
            <input type="text" class="form-control" id="username" readonly>
          </div>

          <div class="mb-3">
            <label for="content" class="form-label">留言内容</label>
            <textarea class="form-control" id="content" required></textarea>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">邮箱</label>
            <input type="email" class="form-control" id="email" required>
          </div>

          <div class="mb-3">
            <label for="phone" class="form-label">电话</label>
            <input type="text" class="form-control" id="phone">
          </div>

          <div class="mb-3">
            <label for="phone" class="form-label">留言时间</label>
            <input type="text" class="form-control" id="createdAt" readonly>
          </div>

          <div class="mb-3">
            <label for="phone" class="form-label">最近修改时间</label>
            <input type="text" class="form-control" id="updatedAt" readonly>
          </div>


          <div class="mb-3">
            <label for="neibie" class="form-label">所属模块</label>
            <select class="form-select" id="neibie">
              <option value="电影">电影</option>
              <option value="音乐">音乐</option>
              <option value="建议">建议</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">Save</button>
        </form>
      </div>
    </div>
  </div>

  <!-- News List -->
  <h2 class="mt-4">News List</h2>
  <div id="news-list"></div>

  <!-- Pagination -->
  <nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>

</div>

<!-- Bootstrap and jQuery Scripts -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let currentPage = 0; // 当前页数
  const pageSize = 3;  // 每页显示的新闻条数

  $(document).ready(function () {
    let currentUser = ''; // 当前用户的用户名

    // 获取当前用户名
    $.ajax({
      url: '/role',  // 假设这是获取当前用户名的接口
      method: "GET",
      success: function (data) {
        currentUser = data.username; // 保存当前用户名
        $('#username').val(currentUser);  // 将用户名填充到输入框
        loadNews(currentPage);  // 加载当前用户的新闻
        console.log(currentUser)
      },
      error: function () {
        alert("Error fetching user data!");
      }
    });

    // 加载新闻数据
    function loadNews(page) {
      $.ajax({
        url: `/newapi/usernews?username=${currentUser}&page=${page}&size=${pageSize}`,  // 传递当前用户名
        method: "GET",
        success: function (data) {
          renderNewsList(data.content);  // 渲染新闻列表
          renderPagination(data.pageable.pageNumber, data.totalPages);  // 渲染分页
        },
        error: function () {
          alert("Error loading data!");
        }
      });
    }

    // <img src="${news.avatarUrl}" height="200" width="200" alt="${news.username} 图片"/>
    //要启用放在下面用户名上方即可
    // 渲染新闻列表
    function renderNewsList(newsList) {
      let html = '';
      newsList.forEach(news => {
        html += `
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">

                        <h5 class="card-title">用户名: ${news.username}</h5>
                        <p class="card-text">留言内容: ${news.content}</p>
                        <p class="text-muted">邮箱: ${news.email} | 电话: ${news.phone}</p>
                        <p class="text-muted">留言时间: ${news.createdAt}</p>
                        <p class="text-muted">最近更新时间: ${news.updatedAt}</p>
                        <span class="badge bg-primary">${news.neibie}</span>
                        <div class="mt-2">
                            <button class="btn btn-warning btn-sm" onclick="editNews(${news.id})">修改</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteNews(${news.id})">删除</button>
                        </div>
                    </div>
                </div>
            `;
      });
      $('#news-list').html(html);
    }

    // 渲染分页
    function renderPagination(currentPage, totalPages) {
      let paginationHtml = '';

      // Previous page button
      paginationHtml += `
            <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
            </li>
        `;

      // Page numbers
      for (let i = 0; i < totalPages; i++) {
        paginationHtml += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i + 1}</a>
                </li>
            `;
      }

      // Next page button
      paginationHtml += `
            <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
            </li>
        `;

      $('#pagination').html(paginationHtml);

      // Page click event
      $('#pagination .page-link').click(function (e) {
        e.preventDefault();
        const page = $(this).data('page');
        if (page >= 0 && page < totalPages) {
          currentPage = page;
          loadNews(currentPage);
        }
      });
    }

    // Edit and Delete news (same as before)
    window.editNews = function (id) {
      $.ajax({
        url: `/api/news/${id}`,
        method: "GET",
        success: function (data) {
          $('#avatarUrl').attr('src', data.avatarUrl);
          $('#newsId').val(data.id);
          $('#username').val(data.username);
          $('#content').val(data.content);
          $('#email').val(data.email);
          $('#phone').val(data.phone);
          $('#createdAt').val(data.createdAt);
          $('#updatedAt').val(data.updatedAt);
          $('#neibie').val(data.neibie);
        },
        error: function () {
          alert("Error loading news data for editing!");
        }
      });
    };

    window.deleteNews = function (id) {
      if (confirm("Are you sure you want to delete this news?")) {
        $.ajax({
          url: `/api/news/${id}`,
          method: "DELETE",
          success: function () {
            loadNews(currentPage);
          },
          error: function () {
            alert("Error deleting news!");
          }
        });
      }
    };

    // Form submission handling for creating/updating news
    $('#newsForm').submit(function (e) {
      e.preventDefault();
      const newsData = {
        id: $('#newsId').val(),
        username: $('#username').val(),
        content: $('#content').val(),
        email: $('#email').val(),
        phone: $('#phone').val(),
        neibie: $('#neibie').val(),
      };

      const method = newsData.id ? 'PUT' : 'POST';
      const url = newsData.id ? `/api/news/${newsData.id}` : '/api/news';

      $.ajax({
        url: url,
        method: method,
        data: JSON.stringify(newsData),
        contentType: 'application/json',
        success: function (data) {
          // 当成功保存时，更新 createdAt 和 updatedAt
          $('#createdAt').val(data.createdAt);  // 留言时间
          $('#updatedAt').val(data.updatedAt);  // 最近修改时间
          loadNews(currentPage);
          $('#newsForm')[0].reset();
        },
        error: function () {
          alert("Error saving news!");
        }
      });
    });
  });

</script>
</body>
</html>
